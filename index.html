<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Center Asset Management - Complete Version</title>
    
    <!-- Material Design CSS -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    
    <style>
        /* Enhanced Professional Styling */
        body {
            background-color: #f5f7fa;
            font-family: 'Roboto', sans-serif;
        }
        
        /* Dashboard Header Enhancement */
        .dashboard-header {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        .dashboard-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            bottom: -50%;
            left: -50%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(30deg);
        }
        
        .dashboard-header h3 {
            margin: 0 0 10px 0;
            font-weight: 300;
            font-size: 2.5rem;
            letter-spacing: 1px;
        }
        
        .dashboard-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        /* Enhanced Statistics Cards */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 80px;
            background: rgba(0,0,0,0.03);
            border-radius: 50%;
            transform: translate(20px, -20px);
        }
        
        .stat-number {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 5px;
            line-height: 1;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }
        
        /* Enhanced Filter Section */
        .filter-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .filter-section h5 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #334155;
            font-weight: 500;
        }
        
        /* Enhanced Asset Cards */
        .asset-card {
            cursor: pointer;
            transition: all 0.3s ease;
            height: 100%;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
            background: white;
            position: relative;
            overflow: visible;
        }
        
        .asset-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .asset-card .card-content {
            padding: 20px;
        }
        
        .asset-card .card-title {
            font-size: 1.3rem;
            font-weight: 500;
            margin-bottom: 15px;
            color: #1e293b;
        }
        
        .asset-card p {
            margin: 8px 0;
            font-size: 0.95rem;
            color: #475569;
        }
        
        .asset-card p strong {
            color: #334155;
            font-weight: 500;
        }
        
        /* Status Colors Enhancement */
        .status-normal { 
            color: #10b981;
            font-weight: 500;
        }
        .status-in-maintenance { 
            color: #f59e0b;
            font-weight: 500;
        }
        .status-fault-shutdown { 
            color: #ef4444;
            font-weight: 500;
        }
        
        /* Maintenance Status Cards */
        .maintenance-due-soon {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(to right, #fef3c7 0%, white 100%);
        }
        
        .maintenance-overdue {
            border-left: 4px solid #ef4444;
            background: linear-gradient(to right, #fee2e2 0%, white 100%);
        }
        
        /* Loading Spinner Enhancement */
        .loading-spinner {
            text-align: center;
            padding: 60px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        /* Modal Enhancements */
        .modal {
            border-radius: 12px;
            overflow: hidden;
        }
        
        .modal .modal-content {
            padding: 30px;
        }
        
        .modal h4 {
            margin-top: 0;
            color: #1e293b;
            font-weight: 500;
        }
        
        .modal .modal-footer {
            background-color: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }
        
        /* Tabs Enhancement */
        .tabs {
            background-color: transparent;
            margin-bottom: 20px;
        }
        
        .tabs .tab a {
            color: #64748b;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        
        .tabs .tab a:hover, .tabs .tab a.active {
            color: #1976d2;
            background-color: rgba(25, 118, 210, 0.05);
        }
        
        .tabs .indicator {
            background-color: #1976d2;
            height: 3px;
        }
        
        /* Test Step Enhancement */
        .test-step {
            margin-bottom: 20px;
            padding: 20px;
            border-left: 4px solid #1976d2;
            background-color: #f8fafc;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .test-step:hover {
            background-color: #f1f5f9;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .test-step.completed {
            border-left-color: #10b981;
            background-color: #f0fdf4;
        }
        
        .test-step.failed {
            border-left-color: #ef4444;
            background-color: #fef2f2;
        }
        
        .test-step h6 {
            margin-top: 0;
            color: #1e293b;
            font-weight: 500;
        }
        
        /* Fix dropdown positioning to prevent covering radio buttons */
        .test-step .input-field {
            margin-bottom: 0;
        }
        
        .test-step .select-wrapper {
            margin-bottom: 15px;
        }
        
        .test-step .select-dropdown {
            margin-bottom: 0;
        }
        
        /* Ensure proper spacing for radio buttons */
        .test-step-controls {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            margin-top: 15px;
        }
        
        .test-step-performer {
            flex: 1;
            min-width: 250px;
        }
        
        .test-step-result {
            flex: 0 0 auto;
            padding-top: 10px;
        }
        
        /* Image Modal Enhancement */
        #imageModal {
            max-width: 95%;
            max-height: 95%;
            width: auto;
            height: auto;
        }
        
        #imageModal .modal-content {
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #000;
        }
        
        .image-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            background: #000;
            position: relative;
        }
        
        .image-container img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            display: block;
        }
        
        /* Image modal footer styling */
        #imageModal .modal-footer {
            background-color: rgba(0,0,0,0.9);
            border-top: 1px solid #333;
            padding: 10px 24px;
            position: relative;
            z-index: 10;
        }
        
        #imageModal .modal-footer .btn-flat {
            color: white;
        }
        
        #imageModal .modal-footer .btn-flat:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        /* Zoom controls for image */
        .image-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 5;
        }
        
        .image-controls .btn-floating {
            background-color: rgba(0,0,0,0.7);
        }
        
        .image-controls .btn-floating:hover {
            background-color: rgba(0,0,0,0.9);
        }
        
        /* Responsive Grid Enhancement */
        @media only screen and (max-width: 600px) {
            .summary-stats {
                grid-template-columns: 1fr;
            }
            
            .dashboard-header h3 {
                font-size: 2rem;
            }
        }
        
        /* Animation for cards appearing */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .asset-card {
            animation: fadeInUp 0.5s ease-out;
            animation-fill-mode: both;
        }
        
        .asset-card:nth-child(1) { animation-delay: 0.1s; }
        .asset-card:nth-child(2) { animation-delay: 0.2s; }
        .asset-card:nth-child(3) { animation-delay: 0.3s; }
        .asset-card:nth-child(4) { animation-delay: 0.4s; }
        .asset-card:nth-child(5) { animation-delay: 0.5s; }
        .asset-card:nth-child(6) { animation-delay: 0.6s; }
        
        /* Warning and Info Badges */
        .maintenance-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-top: 10px;
        }
        
        .maintenance-badge.overdue {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .maintenance-badge.due-soon {
            background-color: #fef3c7;
            color: #d97706;
        }
        
        .maintenance-badge i {
            margin-right: 4px;
            font-size: 16px;
        }
        
        /* Enhanced Asset Modal Styling */
        .asset-info-header {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 30px;
            margin: -30px -30px 30px -30px;
            position: relative;
            overflow: hidden;
        }
        
        .asset-info-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            bottom: -50%;
            left: -50%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(-30deg);
        }
        
        .asset-info-header h4 {
            margin: 0;
            font-weight: 300;
            position: relative;
            z-index: 1;
        }
        
        .asset-info-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            margin-top: 10px;
            font-size: 0.9rem;
            position: relative;
            z-index: 1;
        }
        
        /* Info Cards in Modal */
        .info-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .info-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        
        .info-card h6 {
            color: #1976d2;
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 500;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .info-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 4px;
        }
        
        .info-value {
            font-size: 1rem;
            color: #1e293b;
            font-weight: 500;
        }
        
        /* Enhanced Test Procedure Cards */
        .procedure-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .procedure-card:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            transform: translateY(-3px);
        }
        
        .procedure-card .card-title {
            color: #1e293b;
            font-size: 1.3rem;
            margin-bottom: 15px;
        }
        
        .procedure-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #64748b;
        }
        
        .meta-item i {
            color: #1976d2;
        }
        
        /* Test History Timeline */
        .test-timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .test-timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e2e8f0;
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 30px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -34px;
            top: 5px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #1976d2;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .timeline-item.passed::before {
            background: #10b981;
        }
        
        .timeline-item.failed::before {
            background: #ef4444;
        }
        
        .timeline-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* Maintenance History Cards */
        .maintenance-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .maintenance-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .maintenance-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .maintenance-type.preventive {
            background: #e0f2fe;
            color: #0369a1;
        }
        
        .maintenance-type.corrective {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .maintenance-type.routine {
            background: #f0fdf4;
            color: #15803d;
        }
        
        /* Enhanced Dashboard Cards */
        .asset-card {
            position: relative;
            overflow: visible;
        }
        
        .asset-type-icon {
            position: absolute;
            top: -10px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-size: 24px;
            color: #1976d2;
        }
        
        /* Personnel fields styling */
        .personnel-section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }
        
        .personnel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .step-performer {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .step-timestamp {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 5px;
        }
        
        /* Test Step Wizard Enhancement */
        .test-wizard-container {
            position: relative;
            min-height: 400px;
        }
        
        .test-wizard-progress {
            margin-bottom: 30px;
        }
        
        .test-wizard-step {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        
        .test-wizard-step.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            position: relative;
        }
        
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
        }
        
        .step-indicator-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            color: #9e9e9e;
            position: relative;
            z-index: 1;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .step-indicator-item.completed {
            background: #4caf50;
            border-color: #4caf50;
            color: white;
        }
        
       .step-indicator-item.active {
            background: #2196f3;
            border-color: #2196f3;
            color: white;
            transform: scale(1.2);
            animation: pulse 1s infinite;
        }
        
     .step-indicator-item.error {
            background: #f44336;
            border-color: #f44336;
            color: white;
        }
        
     @keyframes pulse {
            0% { transform: scale(1.2); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1.2); }
        }
        
        .wizard-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .step-validation-message {
            background: #fff3e0;
            border: 1px solid #ffb74d;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            display: none;
            color: #e65100;
        }
        
        .step-validation-message.error {
            display: block;
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }
        
        .step-validation-message i {
            vertical-align: middle;
            margin-right: 5px;
        }
        
        /* Enhanced personnel section for wizard mode */
        .personnel-step {
            text-align: center;
            padding: 20px;
        }
        
        .personnel-step h5 {
            margin-bottom: 30px;
        }
        
        /* Step summary card */
        .step-summary {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
        }
        
        .step-summary.completed {
            border-left-color: #4caf50;
        }
        
        .step-summary.failed {
            border-left-color: #f44336;
        }
    </style>
    
    <!-- Remove old Google API Client and add new Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <!-- Embed configuration directly -->
    <script>
        const GOOGLE_CONFIG = {
            API_KEY: 'AIzaSyBKMeccFQLd_0Co5ge15hcAXZphr8HePiw',
            CLIENT_ID: '611395134102-b0913rahbehjqghfkasgtlfl9ogojneq.apps.googleusercontent.com',
            SPREADSHEET_ID: '1O3QrecIyS2nrc_w6UpRMthFPCQF5MY5s_NFqsylz3w4',
            SHEETS: {
                ASSETS: 'Assets',
                MAINTENANCE_HISTORY: 'MaintenanceHistory',
                TEST_PROCEDURES: 'TestProcedures',
                TEST_RESULTS: 'TestResults'
            }
        };
    </script>
    
    <!-- Header -->
    <div class="dashboard-header">
        <div class="container">
            <h3 class="center-align">Data Center Asset Management</h3>
            <p class="center-align">Complete Dashboard with Google Sheets Integration</p>
            <div class="center-align">
                <div id="buttonDiv" style="display: inline-block;"></div>
                <button id="signout_button" class="btn white blue-text" style="display: none;" onclick="handleSignoutClick()">Sign Out</button>
                <span id="user_info" class="white-text" style="display: none; margin-left: 10px;"></span>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Summary Statistics -->
        <div class="summary-stats">
            <div class="stat-card">
                <div class="stat-number" id="totalAssets">0</div>
                <div class="stat-label">Total Assets</div>
            </div>
            <div class="stat-card">
                <div class="stat-number red-text" id="overdueCount">0</div>
                <div class="stat-label">Overdue Maintenance</div>
            </div>
            <div class="stat-card">
                <div class="stat-number orange-text" id="dueSoonCount">0</div>
                <div class="stat-label">Due Soon</div>
            </div>
            <div class="stat-card">
                <div class="stat-number blue-text" id="inMaintenanceCount">0</div>
                <div class="stat-label">In Maintenance</div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filter-section">
            <h5>Filter Assets</h5>
            <div class="row">
                <div class="input-field col s12 m3">
                    <select id="assetTypeFilter">
                        <option value="">All Types</option>
                        <option value="generator">Generator</option>
                        <option value="chiller">Chiller</option>
                        <option value="ups">UPS</option>
                        <option value="pac-unit">PAC Unit</option>
                        <option value="fan-wall-unit">Fan Wall Unit</option>
                        <option value="power-train-unit">Power Train Unit</option>
                    </select>
                    <label>Asset Type</label>
                </div>
                
                <div class="input-field col s12 m3">
                    <select id="buildingFilter">
                        <option value="">All Buildings</option>
                    </select>
                    <label>Building</label>
                </div>
                
                <div class="input-field col s12 m3">
                    <select id="floorFilter">
                        <option value="">All Floors</option>
                    </select>
                    <label>Floor</label>
                </div>
                
                <div class="input-field col s12 m3">
                    <select id="maintenanceFilter">
                        <option value="">All Statuses</option>
                        <option value="due-soon">Due Soon (30 days)</option>
                        <option value="overdue">Overdue</option>
                        <option value="in-maintenance">Currently in Maintenance</option>
                    </select>
                    <label>Maintenance Status</label>
                </div>
            </div>
        </div>

        <!-- Assets Grid -->
        <div id="assetsContainer" class="row">
            <div class="loading-spinner">
                <div class="preloader-wrapper big active">
                    <div class="spinner-layer spinner-blue-only">
                        <div class="circle-clipper left">
                            <div class="circle"></div>
                        </div>
                    </div>
                </div>
                <p style="color: #64748b; margin-top: 20px;">Loading assets...</p>
            </div>
        </div>
    </div>

    <!-- Asset Detail Modal -->
    <div id="assetModal" class="modal modal-fixed-footer" style="width: 90%; max-width: 1200px;">
        <div class="modal-content" style="padding: 0;">
            <div class="asset-info-header">
                <h4 id="modalAssetName"></h4>
                <div class="asset-info-badge" id="modalAssetType"></div>
            </div>
            
            <div style="padding: 30px;">
                <!-- Tabs -->
                <div class="row">
                    <div class="col s12">
                        <ul class="tabs">
                            <li class="tab col s3"><a class="active" href="#assetInfo">
                                <i class="material-icons">info</i> Information
                            </a></li>
                            <li class="tab col s3"><a href="#maintenanceHistory">
                                <i class="material-icons">build</i> Maintenance
                            </a></li>
                            <li class="tab col s3"><a href="#testProcedures">
                                <i class="material-icons">assignment</i> Test Procedures
                            </a></li>
                            <li class="tab col s3"><a href="#testHistory">
                                <i class="material-icons">history</i> Test History
                            </a></li>
                        </ul>
                    </div>
                </div>
                
                <!-- Tab Content -->
                <div id="assetInfo" class="col s12"></div>
                <div id="maintenanceHistory" class="col s12"></div>
                <div id="testProcedures" class="col s12"></div>
                <div id="testHistory" class="col s12"></div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
        </div>
    </div>

    <!-- Test Execution Modal -->
    <div id="testModal" class="modal modal-fixed-footer" style="width: 80%; max-width: 1000px;">
        <div class="modal-content">
            <h4 id="testProcedureName"></h4>
            <div class="switch" style="margin-bottom: 20px;">
                <label>
                    Classic View
                    <input type="checkbox" id="wizardModeToggle" checked>
                    <span class="lever"></span>
                    Step-by-Step Mode
                </label>
            </div>
            <div id="testContent"></div>
        </div>
        <div class="modal-footer">
            <a href="#!" id="cancelTest" class="modal-close waves-effect waves-red btn-flat">Cancel</a>
            <a href="#!" id="submitTest" class="waves-effect waves-green btn" onclick="submitTestResults()">Submit Results</a>
        </div>
    </div>

    <!-- Test Results Modal -->
    <div id="resultsModal" class="modal">
        <div class="modal-content">
            <h4>Test Results Summary</h4>
            <div id="resultsSummary"></div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <div class="image-container">
                <img id="previewImage" src="" alt="Procedure Image">
                <div class="image-controls">
                    <a class="btn-floating btn-small waves-effect waves-light" onclick="zoomImage(-0.1)">
                        <i class="material-icons">remove</i>
                    </a>
                    <a class="btn-floating btn-small waves-effect waves-light" onclick="resetZoom()">
                        <i class="material-icons">fullscreen</i>
                    </a>
                    <a class="btn-floating btn-small waves-effect waves-light" onclick="zoomImage(0.1)">
                        <i class="material-icons">add</i>
                    </a>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-light btn-flat">
                <i class="material-icons left">close</i>Close
            </a>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    
    <script>
        // Google API configuration
        const DISCOVERY_DOCS = ['https://sheets.googleapis.com/$discovery/rest?version=v4'];
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let currentUser = null;

        // Global variables
        let allAssets = [];
        let filteredAssets = [];
        let maintenanceHistory = [];
        let testProcedures = [];
        let testResultsHistory = [];
        let currentAsset = null;
        let currentTest = null;
        let testResults = {};
        let currentImageZoom = 1;
        let currentWizardStep = 0;
        let wizardMode = true;

        // Initialize when DOM is loaded - ONLY ONCE
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Initializing...');
            
            // Initialize Materialize components
            M.FormSelect.init(document.querySelectorAll('select'));
            
            // Initialize all modals
            const modals = document.querySelectorAll('.modal');
            M.Modal.init(modals);
            
            M.Tabs.init(document.querySelectorAll('.tabs'));
            
            // Load all data
            loadAllData();
            
            // Setup event listeners
            document.getElementById('assetTypeFilter').addEventListener('change', filterAssets);
            document.getElementById('buildingFilter').addEventListener('change', filterAssets);
            document.getElementById('floorFilter').addEventListener('change', filterAssets);
            document.getElementById('maintenanceFilter').addEventListener('change', filterAssets);
            
            // Initialize Google APIs with a slight delay to ensure libraries are loaded
            setTimeout(() => {
                initializeGoogleServices();
            }, 500);
        });

        // New function to handle Google services initialization
        function initializeGoogleServices() {
            console.log('Initializing Google services...');
            
            // Check if gapi is available
            if (typeof gapi !== 'undefined') {
                gapiLoad();
            } else {
                console.error('Google API (gapi) not loaded');
                showFallbackButton('Google API failed to load. Please refresh the page.');
                return;
            }
            
            // Check if google identity services is available
            if (typeof google !== 'undefined' && google.accounts) {
                gisLoad();
            } else {
                console.warn('Google Identity Services not loaded immediately, retrying...');
                // Retry a few times
                let retries = 0;
                const maxRetries = 5;
                const retryInterval = setInterval(() => {
                    retries++;
                    if (typeof google !== 'undefined' && google.accounts) {
                        clearInterval(retryInterval);
                        gisLoad();
                    } else if (retries >= maxRetries) {
                        clearInterval(retryInterval);
                        console.error('Google Identity Services failed to load after retries');
                        showFallbackButton('Authentication service unavailable. Please refresh the page.');
                    }
                }, 1000);
            }
        }

        // Function to show fallback button
        function showFallbackButton(message) {
            document.getElementById('buttonDiv').innerHTML = 
                `<button class="btn white blue-text" onclick="initializeGoogleServices()">
                    <i class="material-icons left">refresh</i>Retry Authentication
                </button>
                <p style="color: white; font-size: 0.9rem; margin-top: 10px;">${message}</p>`;
        }

        // New Google Identity Services implementation
        function gapiLoad() {
            console.log('Loading Google API...');
            gapi.load('client', gapiInit);
        }

        async function gapiInit() {
            try {
                await gapi.client.init({
                    apiKey: GOOGLE_CONFIG.API_KEY,
                    discoveryDocs: DISCOVERY_DOCS,
                });
                gapiInited = true;
                console.log('Google API initialized successfully');
                maybeEnableButtons();
            } catch (error) {
                console.error('Error initializing Google API:', error);
                showFallbackButton('Failed to initialize Google API. Click to retry.');
            }
        }

        function gisLoad() {
            try {
                console.log('Loading Google Identity Services...');
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CONFIG.CLIENT_ID,
                    scope: SCOPES,
                    callback: '', // defined later
                });
                gisInited = true;
                console.log('Google Identity Services loaded successfully');
                maybeEnableButtons();
            } catch (error) {
                console.error('Error initializing Google Identity Services:', error);
                // Show retry button
                showFallbackButton('Failed to initialize authentication. Click to retry.');
            }
        }

        function maybeEnableButtons() {
            console.log('Checking if both services are ready...', { gapiInited, gisInited });
            
            if (gapiInited && gisInited) {
                console.log('Both GAPI and GIS initialized, setting up auth...');
                
                // Check if we have stored credentials
                const storedToken = localStorage.getItem('gapi_token');
                if (storedToken) {
                    gapi.client.setToken({access_token: storedToken});
                    // Verify token is still valid
                    verifyToken(storedToken);
                } else {
                    // Always use manual sign-in button for reliability
                    renderSignInButton();
                }
            }
        }

        // New function to render sign-in button
        function renderSignInButton() {
            const buttonDiv = document.getElementById('buttonDiv');
            if (buttonDiv) {
                buttonDiv.innerHTML = 
                    '<button class="btn white blue-text waves-effect waves-light" onclick="handleManualSignIn()" style="min-width: 200px;">' +
                    '<i class="material-icons left">account_circle</i>Sign In with Google' +
                    '</button>';
                console.log('Sign-in button rendered');
            } else {
                console.error('Button div not found');
            }
        }

        async function verifyToken(token) {
            try {
                // Try to make a simple API call to verify the token
                const response = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: GOOGLE_CONFIG.SPREADSHEET_ID
                });
                
                if (response.status === 200) {
                    // Token is valid
                    updateUIForSignedIn();
                    uploadLocalResults();
                }
            } catch (error) {
                console.error('Token verification failed:', error);
                // Token is invalid, clear it and show sign-in button
                localStorage.removeItem('gapi_token');
                gapi.client.setToken(null);
                maybeEnableButtons();
            }
        }

        function handleManualSignIn() {
            console.log('Manual sign-in button clicked');
            
            // Check if services are initialized
            if (!gapiInited || !gisInited) {
                M.toast({html: 'Authentication system not ready. Retrying...', classes: 'orange'});
                initializeGoogleServices();
                return;
            }
            
            if (tokenClient) {
                console.log('Requesting access token...');
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        console.error('Token error:', resp);
                        M.toast({html: 'Sign-in failed. Please try again.', classes: 'red'});
                        return;
                    }
                    console.log('Token received successfully');
                    
                    // Store token
                    localStorage.setItem('gapi_token', resp.access_token);
                    gapi.client.setToken({access_token: resp.access_token});
                    
                    // Get user info manually
                    currentUser = {
                        email: 'Authenticated User',
                        name: 'User',
                        picture: ''
                    };
                    
                    updateUIForSignedIn();
                    
                    // Upload any local results
                    await uploadLocalResults();
                };
                
                try {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } catch (error) {
                    console.error('Error requesting access token:', error);
                    M.toast({html: 'Failed to open sign-in window. Please check your pop-up blocker.', classes: 'red'});
                }
            } else {
                M.toast({html: 'Authentication system not ready. Please wait...', classes: 'orange'});
                // Retry initialization
                initializeGoogleServices();
            }
        }

        function handleCredentialResponse(response) {
            console.log('Credential response received');
            
            // Decode the JWT credential response
            const responsePayload = decodeJwtResponse(response.credential);
            currentUser = {
                email: responsePayload.email,
                name: responsePayload.name,
                picture: responsePayload.picture
            };
            
            // Request access token for Sheets API
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error('Token error:', resp);
                    M.toast({html: 'Failed to get access token', classes: 'red'});
                    return;
                }
                // Store token
                localStorage.setItem('gapi_token', resp.access_token);
                gapi.client.setToken({access_token: resp.access_token});
                updateUIForSignedIn();
                
                // Upload any local results
                await uploadLocalResults();
            };

            tokenClient.requestAccessToken({prompt: ''});
        }

        // Add the missing decodeJwtResponse function
        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        function updateUIForSignedIn() {
            document.getElementById('buttonDiv').style.display = 'none';
            document.getElementById('signout_button').style.display = 'inline-block';
            if (currentUser && currentUser.email) {
                document.getElementById('user_info').textContent = `Signed in as: ${currentUser.email}`;
                document.getElementById('user_info').style.display = 'inline';
            } else {
                // If we don't have user info, just show generic message
                document.getElementById('user_info').textContent = 'Signed in';
                document.getElementById('user_info').style.display = 'inline';
            }
            M.toast({html: 'Successfully signed in to Google', classes: 'green'});
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                localStorage.removeItem('gapi_token');
                currentUser = null;
                
                document.getElementById('buttonDiv').style.display = 'inline-block';
                document.getElementById('signout_button').style.display = 'none';
                document.getElementById('user_info').style.display = 'none';
                
                // Re-render sign-in button
                renderSignInButton();
                
                M.toast({html: 'Signed out successfully', classes: 'blue'});
            }
        }

        async function loadAllData() {
            try {
                await Promise.all([
                    loadAssets(),
                    loadMaintenanceHistory(),
                    loadTestProcedures(),
                    loadTestResults()
                ]);
                
                populateFilters();
                filterAssets();
                updateStatistics();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadAssets() {
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_CONFIG.SPREADSHEET_ID}/values/${GOOGLE_CONFIG.SHEETS.ASSETS}!A2:Z?key=${GOOGLE_CONFIG.API_KEY}`
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.values) {
                    allAssets = data.values.map(row => ({
                        id: row[0],
                        name: row[1],
                        type: row[2],
                        building: row[3],
                        floor: row[4],
                        status: row[5],
                        nextMaintenanceDate: row[6],
                        lastMaintenanceDate: row[7],
                        serialNumber: row[8],
                        manufacturer: row[9],
                        model: row[10],
                        installationDate: row[11]
                    }));
                }
            } catch (error) {
                console.error('Error loading assets:', error);
                document.getElementById('assetsContainer').innerHTML = `
                    <div class="col s12">
                        <div class="card-panel red lighten-4">
                            <span class="red-text">Error loading assets: ${error.message}</span>
                            <br><br>
                            <small>Check console for details. Make sure your Google Sheets API is configured correctly.</small>
                        </div>
                    </div>
                `;
            }
        }

        async function loadMaintenanceHistory() {
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_CONFIG.SPREADSHEET_ID}/values/${GOOGLE_CONFIG.SHEETS.MAINTENANCE_HISTORY}!A2:Z?key=${GOOGLE_CONFIG.API_KEY}`
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.values) {
                    maintenanceHistory = data.values.map(row => ({
                        id: row[0],
                        assetId: row[1],
                        date: row[2],
                        type: row[3],
                        technician: row[4],
                        description: row[5],
                        partsReplaced: row[6],
                        nextMaintenanceDate: row[7]
                    }));
                }
            } catch (error) {
                console.error('Error loading maintenance history:', error);
            }
        }

        async function loadTestProcedures() {
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_CONFIG.SPREADSHEET_ID}/values/${GOOGLE_CONFIG.SHEETS.TEST_PROCEDURES}!A2:Z?key=${GOOGLE_CONFIG.API_KEY}`
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.values) {
                    // Group procedures by ID
                    const procedureMap = new Map();
                    
                    data.values.forEach(row => {
                        const procedureId = row[0];
                        const step = {
                            stepNumber: parseInt(row[3]),
                            description: row[4],
                            expectedResult: row[5],
                            imageUrl: row[6],
                            warningNotes: row[7]
                        };
                        
                        if (!procedureMap.has(procedureId)) {
                            procedureMap.set(procedureId, {
                                id: procedureId,
                                assetType: row[1],
                                name: row[2],
                                estimatedDuration: parseInt(row[8]) || 30,
                                steps: []
                            });
                        }
                        
                        procedureMap.get(procedureId).steps.push(step);
                    });
                    
                    testProcedures = Array.from(procedureMap.values());
                }
            } catch (error) {
                console.error('Error loading test procedures:', error);
            }
        }

        async function loadTestResults() {
            try {
                // Check if user is signed in
                if (gapi.client.getToken() !== null) {
                    const response = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: GOOGLE_CONFIG.SPREADSHEET_ID,
                        range: `${GOOGLE_CONFIG.SHEETS.TEST_RESULTS}!A2:Q`
                    });
                    
                    if (response.result.values) {
                        // Group results by test instance (using timestamp)
                        const testMap = new Map();
                        
                        response.result.values.forEach(row => {
                            const key = `${row[0]}-${row[3]}-${row[6]}`; // assetId-procedureId-timestamp
                            
                            if (!testMap.has(key)) {
                                testMap.set(key, {
                                    assetId: row[0],
                                    procedureId: row[3],
                                    date: row[5],
                                    technicians: row[7], // Now contains list of technicians
                                    contractors: row[8], // Contains list of contractors
                                    overallStatus: row[15],
                                    notes: row[16],
                                    timestamp: row[6]
                                });
                            }
                        });
                        
                        testResultsHistory = Array.from(testMap.values());
                    }
                } else {
                    // Not signed in, use public API
                    const response = await fetch(
                        `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_CONFIG.SPREADSHEET_ID}/values/${GOOGLE_CONFIG.SHEETS.TEST_RESULTS}!A2:Q?key=${GOOGLE_CONFIG.API_KEY}`
                    );
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.values) {
                        // Group results by test instance (using timestamp)
                        const testMap = new Map();
                        
                        data.values.forEach(row => {
                            const key = `${row[0]}-${row[3]}-${row[6]}`; // assetId-procedureId-timestamp
                            
                            if (!testMap.has(key)) {
                                testMap.set(key, {
                                    assetId: row[0],
                                    procedureId: row[3],
                                    date: row[5],
                                    technicians: row[7], // Now contains list of technicians
                                    contractors: row[8], // Contains list of contractors
                                    overallStatus: row[15],
                                    notes: row[16],
                                    timestamp: row[6]
                                });
                            }
                        });
                        
                        testResultsHistory = Array.from(testMap.values());
                    }
                }
            } catch (error) {
                console.error('Error loading test results:', error);
                testResultsHistory = [];
            }
        }

        function updateStatistics() {
            const stats = {
                total: allAssets.length,
                overdue: 0,
                dueSoon: 0,
                inMaintenance: 0
            };
            
            allAssets.forEach(asset => {
                const maintenanceStatus = getMaintenanceStatus(asset);
                if (maintenanceStatus === 'overdue') stats.overdue++;
                else if (maintenanceStatus === 'due-soon') stats.dueSoon++;
                
                if (asset.status === 'in maintenance') stats.inMaintenance++;
            });
            
            document.getElementById('totalAssets').textContent = stats.total;
            document.getElementById('overdueCount').textContent = stats.overdue;
            document.getElementById('dueSoonCount').textContent = stats.dueSoon;
            document.getElementById('inMaintenanceCount').textContent = stats.inMaintenance;
        }

        function populateFilters() {
            // Populate building filter
            const buildings = [...new Set(allAssets.map(a => a.building))].filter(Boolean).sort();
            const buildingSelect = document.getElementById('buildingFilter');
            buildingSelect.innerHTML = '<option value="">All Buildings</option>';
            buildings.forEach(building => {
                const option = document.createElement('option');
                option.value = building;
                option.textContent = building;
                buildingSelect.appendChild(option);
            });
            
            // Populate floor filter
            const floors = [...new Set(allAssets.map(a => a.floor))].filter(Boolean).sort();
            const floorSelect = document.getElementById('floorFilter');
            floorSelect.innerHTML = '<option value="">All Floors</option>';
            floors.forEach(floor => {
                const option = document.createElement('option');
                option.value = floor;
                option.textContent = floor;
                floorSelect.appendChild(option);
            });
            
            // Reinitialize selects
            M.FormSelect.init(document.querySelectorAll('select'));
        }

        function filterAssets() {
            const typeFilter = document.getElementById('assetTypeFilter').value;
            const buildingFilter = document.getElementById('buildingFilter').value;
            const floorFilter = document.getElementById('floorFilter').value;
            const maintenanceFilter = document.getElementById('maintenanceFilter').value;
            
            filteredAssets = allAssets.filter(asset => {
                if (typeFilter && asset.type !== typeFilter) return false;
                if (buildingFilter && asset.building !== buildingFilter) return false;
                if (floorFilter && asset.floor !== floorFilter) return false;
                
                if (maintenanceFilter) {
                    const maintenanceStatus = getMaintenanceStatus(asset);
                    if (maintenanceFilter === 'in-maintenance' && asset.status !== 'in maintenance') return false;
                    if (maintenanceFilter === 'due-soon' && maintenanceStatus !== 'due-soon') return false;
                    if (maintenanceFilter === 'overdue' && maintenanceStatus !== 'overdue') return false;
                }
                
                return true;
            });
            
            displayAssets();
        }

        function getMaintenanceStatus(asset) {
            if (asset.status === 'in maintenance') return 'in-maintenance';
            
            const today = new Date();
            const nextMaintenance = parseDate(asset.nextMaintenanceDate);
            const diffDays = Math.ceil((nextMaintenance - today) / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) return 'overdue';
            if (diffDays <= 30) return 'due-soon';
            return 'normal';
        }

        function parseDate(dateStr) {
            if (!dateStr) return new Date();
            const parts = dateStr.split('/');
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }

        function displayAssets() {
            const container = document.getElementById('assetsContainer');
            
            if (filteredAssets.length === 0) {
                container.innerHTML = `
                    <div class="col s12">
                        <div class="card-panel" style="text-align: center; padding: 40px;">
                            <i class="material-icons" style="font-size: 48px; color: #94a3b8;">search_off</i>
                            <p style="color: #64748b; margin-top: 10px;">No assets found matching the selected filters.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredAssets.map((asset, index) => {
                const maintenanceStatus = getMaintenanceStatus(asset);
                const statusClass = asset.status.replace(/[\s\/]/g, '-').toLowerCase();
                const maintenanceClass = maintenanceStatus === 'overdue' ? 'maintenance-overdue' : 
                                       maintenanceStatus === 'due-soon' ? 'maintenance-due-soon' : '';
                
                // Get icon for asset type
                const assetIcons = {
                    'generator': 'power',
                    'chiller': 'ac_unit',
                    'ups': 'battery_charging_full',
                    'pac-unit': 'air',
                    'fan-wall-unit': 'toys',
                    'power-train-unit': 'electrical_services'
                };
                const icon = assetIcons[asset.type] || 'settings';
                
                return `
                    <div class="col s12 m6 l4" style="animation-delay: ${index * 0.1}s">
                        <div class="card asset-card ${maintenanceClass}" onclick="showAssetDetails('${asset.id}')">
                            <div class="asset-type-icon">
                                <i class="material-icons">${icon}</i>
                            </div>
                            <div class="card-content">
                                <span class="card-title">${asset.name}</span>
                                <p><strong>Type:</strong> ${asset.type.replace(/-/g, ' ').toUpperCase()}</p>
                                <p><strong>Location:</strong> ${asset.building} - Floor ${asset.floor}</p>
                                <p><strong>Status:</strong> <span class="status-${statusClass}">${asset.status}</span></p>
                                <p><strong>Next Maintenance:</strong> ${asset.nextMaintenanceDate}</p>
                                ${maintenanceStatus === 'overdue' ? 
                                    '<div class="maintenance-badge overdue"><i class="material-icons tiny">warning</i>Maintenance Overdue</div>' : ''}
                                ${maintenanceStatus === 'due-soon' ? 
                                    '<div class="maintenance-badge due-soon"><i class="material-icons tiny">schedule</i>Due Soon</div>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showAssetDetails(assetId) {
            currentAsset = allAssets.find(a => a.id === assetId);
            if (!currentAsset) return;
            
            document.getElementById('modalAssetName').textContent = currentAsset.name;
            document.getElementById('modalAssetType').textContent = currentAsset.type.replace(/-/g, ' ').toUpperCase();
            
            // Show asset information
            showAssetInfo();
            
            // Show maintenance history
            showMaintenanceHistory();
            
            // Show test procedures
            showTestProcedures();
            
            // Show test history
            showTestHistory();
            
            // Open modal and reset to first tab
            const modal = M.Modal.getInstance(document.getElementById('assetModal'));
            const tabs = M.Tabs.getInstance(document.querySelector('.tabs'));
            tabs.select('assetInfo');
            modal.open();
        }

        function showAssetInfo() {
            const container = document.getElementById('assetInfo');
            const maintenanceStatus = getMaintenanceStatus(currentAsset);
            
            container.innerHTML = `
                <div class="row">
                    <div class="col s12">
                        <div class="info-card">
                            <h6><i class="material-icons left">dashboard</i>Asset Overview</h6>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">Asset ID</div>
                                    <div class="info-value">${currentAsset.id}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Type</div>
                                    <div class="info-value">${currentAsset.type.replace(/-/g, ' ').toUpperCase()}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Status</div>
                                    <div class="info-value status-${currentAsset.status.replace(/[\s\/]/g, '-').toLowerCase()}">${currentAsset.status}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Maintenance Status</div>
                                    <div class="info-value">
                                        ${maintenanceStatus === 'overdue' ? '<span class="red-text">Overdue</span>' :
                                          maintenanceStatus === 'due-soon' ? '<span class="orange-text">Due Soon</span>' :
                                          '<span class="green-text">On Schedule</span>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-card">
                            <h6><i class="material-icons left">location_on</i>Location Details</h6>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">Building</div>
                                    <div class="info-value">${currentAsset.building}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Floor</div>
                                    <div class="info-value">${currentAsset.floor}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-card">
                            <h6><i class="material-icons left">settings</i>Technical Details</h6>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">Serial Number</div>
                                    <div class="info-value">${currentAsset.serialNumber}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Manufacturer</div>
                                    <div class="info-value">${currentAsset.manufacturer}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Model</div>
                                    <div class="info-value">${currentAsset.model}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Installation Date</div>
                                    <div class="info-value">${currentAsset.installationDate}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-card">
                            <h6><i class="material-icons left">schedule</i>Maintenance Schedule</h6>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">Last Maintenance</div>
                                    <div class="info-value">${currentAsset.lastMaintenanceDate}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Next Maintenance</div>
                                    <div class="info-value">${currentAsset.nextMaintenanceDate}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showMaintenanceHistory() {
            const container = document.getElementById('maintenanceHistory');
            const assetHistory = maintenanceHistory.filter(record => record.assetId === currentAsset.id);
            
            if (assetHistory.length === 0) {
                container.innerHTML = `
                    <div class="info-card">
                        <p class="center-align" style="color: #64748b;">
                            <i class="material-icons" style="font-size: 48px;">build</i><br>
                            No maintenance history available for this asset.
                        </p>
                    </div>
                `;
                return;
            }
            
            // Sort by date (newest first)
            assetHistory.sort((a, b) => parseDate(b.date) - parseDate(a.date));
            
            container.innerHTML = `
                <h5>Maintenance History</h5>
                ${assetHistory.map(record => {
                    const typeClass = record.type.toLowerCase().includes('preventive') ? 'preventive' : 
                                    record.type.toLowerCase().includes('corrective') ? 'corrective' : 'routine';
                    return `
                        <div class="maintenance-card">
                            <div class="maintenance-type ${typeClass}">${record.type}</div>
                            <h6 style="margin-top: 10px;">${record.date}</h6>
                            <p><strong>Technician:</strong> ${record.technician}</p>
                            <p><strong>Description:</strong> ${record.description}</p>
                            ${record.partsReplaced ? `<p><strong>Parts Replaced:</strong> ${record.partsReplaced}</p>` : ''}
                        </div>
                    `;
                }).join('')}
            `;
        }

        function showTestProcedures() {
            const container = document.getElementById('testProcedures');
            const assetProcedures = testProcedures.filter(proc => proc.assetType === currentAsset.type);
            
            if (assetProcedures.length === 0) {
                container.innerHTML = `
                    <div class="info-card">
                        <p class="center-align" style="color: #64748b;">
                            <i class="material-icons" style="font-size: 48px;">assignment</i><br>
                            No test procedures available for this asset type.
                        </p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <h5>Available Test Procedures</h5>
                <div class="row">
                    ${assetProcedures.map(procedure => `
                        <div class="col s12">
                            <div class="procedure-card">
                                <h6 class="card-title">${procedure.name}</h6>
                                <div class="procedure-meta">
                                    <div class="meta-item">
                                        <i class="material-icons tiny">timer</i>
                                        <span>${procedure.estimatedDuration} minutes</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="material-icons tiny">format_list_numbered</i>
                                        <span>${procedure.steps.length} steps</span>
                                    </div>
                                </div>
                                <a href="#!" class="btn waves-effect waves-light" onclick="event.preventDefault(); startTest('${procedure.id}')">
                                    <i class="material-icons left">play_arrow</i>Start Test
                                </a>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showTestHistory() {
            const container = document.getElementById('testHistory');
            const assetTests = testResultsHistory.filter(test => test.assetId === currentAsset.id);
            
            if (assetTests.length === 0) {
                container.innerHTML = `
                    <div class="info-card">
                        <p class="center-align" style="color: #64748b;">
                            <i class="material-icons" style="font-size: 48px;">history</i><br>
                            No test history available for this asset.
                        </p>
                    </div>
                `;
                return;
            }
            
            // Sort by date (newest first)
            assetTests.sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));
            
            container.innerHTML = `
                <h5>Test History</h5>
                <div class="test-timeline">
                    ${assetTests.map(test => {
                        // Find the procedure name
                        const procedure = testProcedures.find(p => p.id === test.procedureId);
                        const procedureName = procedure ? procedure.name : test.procedureId;
                        
                        return `
                            <div class="timeline-item ${test.overallStatus}">
                                <div class="timeline-content">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <h6 style="margin: 0;">${procedureName}</h6>
                                        <span class="${test.overallStatus === 'passed' ? 'green-text' : 'red-text'}" style="font-weight: 500;">
                                            ${test.overallStatus ? test.overallStatus.toUpperCase() : 'UNKNOWN'}
                                        </span>
                                    </div>
                                    <p style="color: #64748b; margin: 5px 0;">${test.date}</p>
                                    <p><strong>Technician:</strong> ${test.technician}</p>
                                    ${test.notes ? `<p><strong>Notes:</strong> ${test.notes}</p>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        async function updateAssetStatus(newStatus) {
            try {
                // Find the row number for the current asset
                const assetsResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: GOOGLE_CONFIG.SPREADSHEET_ID,
                    range: `${GOOGLE_CONFIG.SHEETS.ASSETS}!A:A`
                });
                
                const assetIds = assetsResponse.result.values || [];
                const rowIndex = assetIds.findIndex(row => row[0] === currentAsset.id);
                
                if (rowIndex > 0) { // rowIndex 0 is the header
                    // Update the status column (column F = column 6)
                    const updateResponse = await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: GOOGLE_CONFIG.SPREADSHEET_ID,
                        range: `${GOOGLE_CONFIG.SHEETS.ASSETS}!F${rowIndex + 1}`,
                        valueInputOption: 'USER_ENTERED',
                        resource: {
                            values: [[newStatus]]
                        }
                    });
                    
                    console.log('Asset status updated:', updateResponse);
                    
                    // Update the local asset data
                    currentAsset.status = newStatus;
                    const assetIndex = allAssets.findIndex(a => a.id === currentAsset.id);
                    if (assetIndex !== -1) {
                        allAssets[assetIndex].status = newStatus;
                    }
                }
            } catch (error) {
                console.error('Error updating asset status:', error);
                M.toast({html: 'Error updating asset status', classes: 'red'});
            }
        }

        function startTest(procedureId) {
            console.log('Starting test:', procedureId);
            
            currentTest = testProcedures.find(p => p.id === procedureId);
            if (!currentTest) {
                console.error('Test procedure not found:', procedureId);
                M.toast({html: 'Error: Test procedure not found'});
                return;
            }
            
            // Check for saved progress
            const progressLoaded = loadTestProgress();
            
            if (!progressLoaded) {
                // Initialize test results with personnel arrays
                testResults = {
                    assetId: currentAsset.id,
                    procedureId: currentTest.id,
                    date: new Date().toLocaleDateString('en-GB'),
                    technicians: [],
                    contractors: [],
                    steps: {},
                    notes: '',
                    timestamp: new Date().toISOString()
                };
                
                // Reset wizard step
                currentWizardStep = 0;
            }
            
            // Update modal content
            document.getElementById('testProcedureName').textContent = currentTest.name;
            
            // Setup wizard mode toggle
            const wizardToggle = document.getElementById('wizardModeToggle');
            wizardToggle.checked = wizardMode;
            wizardToggle.addEventListener('change', function() {
                wizardMode = this.checked;
                renderTestContent();
            });
            
            renderTestContent();
            
            // Close asset modal
            const assetModal = M.Modal.getInstance(document.getElementById('assetModal'));
            assetModal.close();
            
            // Open test modal after a short delay
            setTimeout(() => {
                const testModal = M.Modal.getInstance(document.getElementById('testModal'));
                testModal.open();
            }, 300);
        }

        function renderTestContent() {
            const content = document.getElementById('testContent');
            
            if (wizardMode) {
                renderWizardMode(content);
            } else {
                renderClassicMode(content);
            }
            
            // Re-initialize Materialize components
            setTimeout(() => {
                initializeMaterializeComponents();
            }, 100);
        }

        function renderWizardMode(container) {
            const totalSteps = currentTest.steps.length + 2; // +1 for personnel, +1 for summary
            
            container.innerHTML = `
                <div class="test-wizard-container">
                    <div class="test-wizard-progress">
                        <div class="step-indicator">
                            <div class="step-indicator-item ${currentWizardStep === 0 ? 'active' : ''}" onclick="goToStep(0)">
                                <i class="material-icons tiny">people</i>
                            </div>
                            ${currentTest.steps.map((step, index) => `
                                <div class="step-indicator-item ${currentWizardStep === index + 1 ? 'active' : ''} ${getStepStatus(step.stepNumber)}" 
                                     onclick="goToStep(${index + 1})" 
                                     title="Step ${step.stepNumber}">
                                    ${step.stepNumber}
                                </div>
                            `).join('')}
                            <div class="step-indicator-item ${currentWizardStep === totalSteps - 1 ? 'active' : ''}" onclick="goToStep(${totalSteps - 1})">
                                <i class="material-icons tiny">check</i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="step-validation-message" id="stepValidationMessage">
                        <i class="material-icons tiny">warning</i>
                        <span id="validationText"></span>
                    </div>
                    
                    <!-- Personnel Step -->
                    <div class="test-wizard-step ${currentWizardStep === 0 ? 'active' : ''}">
                        <div class="personnel-step">
                            <h5>Test Personnel</h5>
                            <p>Please enter at least one technician or contractor who will perform this test.</p>
                            <div class="personnel-grid">
                                <div>
                                    <h6>Technicians</h6>
                                    <div class="input-field">
                                        <input id="technician1" type="text" onchange="updatePersonnel()">
                                        <label for="technician1">Technician 1</label>
                                    </div>
                                    <div class="input-field">
                                        <input id="technician2" type="text" onchange="updatePersonnel()">
                                        <label for="technician2">Technician 2</label>
                                    </div>
                                    <div class="input-field">
                                        <input id="technician3" type="text" onchange="updatePersonnel()">
                                        <label for="technician3">Technician 3</label>
                                    </div>
                                </div>
                                <div>
                                    <h6>Contractors</h6>
                                    <div class="input-field">
                                        <input id="contractor1" type="text" onchange="updatePersonnel()">
                                        <label for="contractor1">Contractor 1</label>
                                    </div>
                                    <div class="input-field">
                                        <input id="contractor2" type="text" onchange="updatePersonnel()">
                                        <label for="contractor2">Contractor 2</label>
                                    </div>
                                    <div class="input-field">
                                        <input id="contractor3" type="text" onchange="updatePersonnel()">
                                        <label for="contractor3">Contractor 3</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                                                                             </div>
                    
                    <!-- Test Steps -->
                    ${currentTest.steps.map((step, index) => `
                        <div class="test-wizard-step ${currentWizardStep === index + 1 ? 'active' : ''}">
                            <div class="test-step" id="step-${step.stepNumber}">
                                <h5>Step ${step.stepNumber} of ${currentTest.steps.length}</h5>
                                <h6>${step.description}</h6>
                                ${step.warningNotes ? `<div class="card-panel amber lighten-4"><i class="material-icons tiny">warning</i> ${step.warningNotes}</div>` : ''}
                                <p><strong>Expected Result:</strong> ${step.expectedResult}</p>
                                ${step.imageUrl ? `
                                    <div style="margin: 10px 0;">
                                        <a href="#!" onclick="event.preventDefault(); showImage('${step.imageUrl}')" class="btn-small waves-effect waves-light">
                                            <i class="material-icons left">image</i>View Example
                                        </a>
                                    </div>
                                ` : ''}
                                
                                <div class="test-step-controls">
                                    <div class="test-step-performer">
                                        <div class="input-field">
                                            <select id="step-${step.stepNumber}-performer" onchange="updateStepPerformer(${step.stepNumber}, this.value)">
                                                <option value="">Select who performed this step</option>
                                            </select>
                                            <label>Performed By</label>
                                        </div>
                                        <div class="step-timestamp" id="step-${step.stepNumber}-timestamp"></div>
                                    </div>
                                    <div class="test-step-result">
                                        <p>
                                            <label>
                                                <input name="step-${step.stepNumber}-result" type="radio" value="pass" onchange="updateStepResult(${step.stepNumber}, 'pass')">
                                                <span>Pass</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="step-${step.stepNumber}-result" type="radio" value="fail" onchange="updateStepResult(${step.stepNumber}, 'fail')">
                                                <span>Fail</span>
                                            </label>
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="input-field">
                                    <textarea id="step-${step.stepNumber}-notes" class="materialize-textarea" onchange="updateStepNotes(${step.stepNumber}, this.value)"></textarea>
                                    <label for="step-${step.stepNumber}-notes">Notes (Optional)</label>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                    
                    <!-- Summary Step -->
                    <div class="test-wizard-step ${currentWizardStep === totalSteps - 1 ? 'active' : ''}">
                        <h5>Test Summary</h5>
                        <div id="wizardSummary"></div>
                        <div class="input-field">
                            <textarea id="overallNotes" class="materialize-textarea" onchange="testResults.notes = this.value"></textarea>
                            <label for="overallNotes">Overall Notes</label>
                        </div>
                    </div>
                    
                    <div class="wizard-navigation">
                        <button class="btn-flat waves-effect" onclick="previousStep()" ${currentWizardStep === 0 ? 'disabled' : ''}>
                            <i class="material-icons left">arrow_back</i>Previous
                        </button>
                        <button class="btn waves-effect waves-light" onclick="nextStep()" id="nextStepBtn">
                            Next<i class="material-icons right">arrow_forward</i>
                        </button>
                    </div>
                </div>
            `;
            
            // Update personnel dropdowns if we're past the first step
            if (currentWizardStep > 0) {
                updatePersonnelDropdowns();
            }
            
            // Update summary if on last step
            if (currentWizardStep === totalSteps - 1) {
                updateWizardSummary();
            }
            
            // Restore previous values
            restoreStepValues();
        }

        function renderClassicMode(container) {
            container.innerHTML = `
                <div class="personnel-section">
                    <h5>Test Personnel</h5>
                    <div class="personnel-grid">
                        <div>
                            <h6>Technicians (up to 3)</h6>
                            <div class="input-field">
                                <input id="technician1" type="text" onchange="updatePersonnel()" value="${testResults.technicians[0] || ''}">
                                <label for="technician1" ${testResults.technicians[0] ? 'class="active"' : ''}>Technician 1</label>
                            </div>
                            <div class="input-field">
                                <input id="technician2" type="text" onchange="updatePersonnel()" value="${testResults.technicians[1] || ''}">
                                <label for="technician2" ${testResults.technicians[1] ? 'class="active"' : ''}>Technician 2</label>
                            </div>
                            <div class="input-field">
                                <input id="technician3" type="text" onchange="updatePersonnel()" value="${testResults.technicians[2] || ''}">
                                <label for="technician3" ${testResults.technicians[2] ? 'class="active"' : ''}>Technician 3</label>
                            </div>
                        </div>
                        <div>
                            <h6>Contractors (up to 3)</h6>
                            <div class="input-field">
                                <input id="contractor1" type="text" onchange="updatePersonnel()" value="${testResults.contractors[0] || ''}">
                                <label for="contractor1" ${testResults.contractors[0] ? 'class="active"' : ''}>Contractor 1</label>
                            </div>
                            <div class="input-field">
                                <input id="contractor2" type="text" onchange="updatePersonnel()" value="${testResults.contractors[1] || ''}">
                                <label for="contractor2" ${testResults.contractors[1] ? 'class="active"' : ''}>Contractor 2</label>
                            </div>
                            <div class="input-field">
                                <input id="contractor3" type="text" onchange="updatePersonnel()" value="${testResults.contractors[2] || ''}">
                                <label for="contractor3" ${testResults.contractors[2] ? 'class="active"' : ''}>Contractor 3</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h5>Test Steps</h5>
                ${currentTest.steps.sort((a, b) => a.stepNumber - b.stepNumber).map(step => `
                    <div class="test-step ${getStepClass(step.stepNumber)}" id="step-${step.stepNumber}">
                        <h6>Step ${step.stepNumber}: ${step.description}</h6>
                        ${step.warningNotes ? `<div class="card-panel amber lighten-4"><i class="material-icons tiny">warning</i> ${step.warningNotes}</div>` : ''}
                        <p><strong>Expected Result:</strong> ${step.expectedResult}</p>
                        ${step.imageUrl ? `
                            <div style="margin: 10px 0;">
                                <a href="#!" onclick="event.preventDefault(); showImage('${step.imageUrl}')" class="btn-small waves-effect waves-light">
                                    <i class="material-icons left">image</i>View Example
                                </a>
                            </div>
                        ` : ''}
                        
                        <div class="test-step-controls">
                            <div class="test-step-performer">
                                <div class="input-field">
                                    <select id="step-${step.stepNumber}-performer" onchange="updateStepPerformer(${step.stepNumber}, this.value)">
                                        <option value="">Select who performed this step</option>
                                    </select>
                                    <label>Performed By</label>
                                </div>
                                <div class="step-timestamp" id="step-${step.stepNumber}-timestamp"></div>
                            </div>
                            <div class="test-step-result">
                                <p>
                                    <label>
                                        <input name="step-${step.stepNumber}-result" type="radio" value="pass" onchange="updateStepResult(${step.stepNumber}, 'pass')">
                                        <span>Pass</span>
                                    </label>
                                </p>
                                <p>
                                    <label>
                                        <input name="step-${step.stepNumber}-result" type="radio" value="fail" onchange="updateStepResult(${step.stepNumber}, 'fail')">
                                        <span>Fail</span>
                                    </label>
                                </p>
                            </div>
                        </div>
                        
                        <div class="input-field">
                            <textarea id="step-${step.stepNumber}-notes" class="materialize-textarea" onchange="updateStepNotes(${step.stepNumber}, this.value)">${testResults.steps[step.stepNumber]?.notes || ''}</textarea>
                            <label for="step-${step.stepNumber}-notes" ${testResults.steps[step.stepNumber]?.notes ? 'class="active"' : ''}>Notes (Optional)</label>
                        </div>
                    </div>
                `).join('')}
                
                <div class="row">
                    <div class="input-field col s12">
                        <textarea id="overallNotes" class="materialize-textarea" onchange="testResults.notes = this.value">${testResults.notes || ''}</textarea>
                        <label for="overallNotes" ${testResults.notes ? 'class="active"' : ''}>Overall Notes</label>
                    </div>
                </div>
            `;
            
            // Update all dropdowns
            updatePersonnelDropdowns();
            
            // Restore all step values
            restoreAllStepValues();
        }

        function getStepClass(stepNumber) {
            const stepData = testResults.steps[stepNumber];
            if (stepData?.result === 'pass') return 'completed';
            if (stepData?.result === 'fail') return 'failed';
            return '';
        }

        function getStepStatus(stepNumber) {
            const stepData = testResults.steps[stepNumber];
            if (stepData?.result === 'pass') return 'completed';
            if (stepData?.result === 'fail') return 'error';
            return '';
        }

        function validateCurrentStep() {
            const totalSteps = currentTest.steps.length + 2;
            
            if (currentWizardStep === 0) {
                // Validate personnel
                if (testResults.technicians.length === 0 && testResults.contractors.length === 0) {
                    showValidationMessage('Please enter at least one technician or contractor before proceeding.');
                    return false;
                }
            } else if (currentWizardStep < totalSteps - 1) {
                // Validate test step
                const step = currentTest.steps[currentWizardStep - 1];
                const stepData = testResults.steps[step.stepNumber];
                
                if (!stepData || !stepData.result) {
                    showValidationMessage('Please select Pass or Fail for this step.');
                    return false;
                }
                
                if (!stepData.performer || stepData.performer === '') {
                    showValidationMessage('Please select who performed this step.');
                    return false;
                }
            }
            
            hideValidationMessage();
            return true;
        }

        function showValidationMessage(message) {
            const validationEl = document.getElementById('stepValidationMessage');
            const textEl = document.getElementById('validationText');
            
            if (validationEl && textEl) {
                textEl.textContent = message;
                validationEl.classList.add('error');
            }
        }

        function hideValidationMessage() {
            const validationEl = document.getElementById('stepValidationMessage');
            if (validationEl) {
                validationEl.classList.remove('error');
            }
        }

        function nextStep() {
            const totalSteps = currentTest.steps.length + 2;
            
            if (!validateCurrentStep()) {
                M.toast({html: 'Please complete the current step before proceeding.', classes: 'orange'});
                return;
            }
            
            if (currentWizardStep < totalSteps - 1) {
                currentWizardStep++;
                renderTestContent();
                
                // Update button text
                const nextBtn = document.getElementById('nextStepBtn');
                if (currentWizardStep === totalSteps - 1) {
                    nextBtn.innerHTML = 'Review & Submit<i class="material-icons right">check</i>';
                }
            }
        }

        function previousStep() {
            if (currentWizardStep > 0) {
                currentWizardStep--;
                renderTestContent();
                
                // Update button text
                const nextBtn = document.getElementById('nextStepBtn');
                nextBtn.innerHTML = 'Next<i class="material-icons right">arrow_forward</i>';
            }
        }

        function goToStep(stepIndex) {
            // Only allow going to completed steps or the current step
            const canNavigate = stepIndex <= currentWizardStep || isStepCompleted(stepIndex);
            
            if (canNavigate) {
                currentWizardStep = stepIndex;
                renderTestContent();
            } else {
                M.toast({html: 'Please complete previous steps first.', classes: 'orange'});
            }
        }

        function isStepCompleted(stepIndex) {
            if (stepIndex === 0) {
                return testResults.technicians.length > 0 || testResults.contractors.length > 0;
            }
            
            const totalSteps = currentTest.steps.length + 2;
            if (stepIndex < totalSteps - 1) {
                const step = currentTest.steps[stepIndex - 1];
                const stepData = testResults.steps[step.stepNumber];
                return stepData && stepData.result && stepData.performer;
            }
            
            return false;
        }

        function updateWizardSummary() {
            const summaryEl = document.getElementById('wizardSummary');
            if (!summaryEl) return;
            
            const passedSteps = Object.values(testResults.steps).filter(s => s.result === 'pass').length;
            const failedSteps = Object.values(testResults.steps).filter(s => s.result === 'fail').length;
            const totalSteps = currentTest.steps.length;
            
            summaryEl.innerHTML = `
                <div class="row">
                    <div class="col s12">
                        <p><strong>Asset:</strong> ${currentAsset.name}</p>
                        <p><strong>Procedure:</strong> ${currentTest.name}</p>
                        <p><strong>Date:</strong> ${testResults.date}</p>
                        <p><strong>Personnel:</strong></p>
                        <ul>
                            ${testResults.technicians.map(t => `<li>Technician: ${t}</li>`).join('')}
                            ${testResults.contractors.map(c => `<li>Contractor: ${c}</li>`).join('')}
                        </ul>
                        
                        <h6>Test Results</h6>
                        <p><strong>Passed:</strong> ${passedSteps} steps</p>
                        <p><strong>Failed:</strong> ${failedSteps} steps</p>
                        
                        ${failedSteps > 0 ? `
                            <div class="card-panel amber lighten-4" style="margin-top: 20px;">
                                <i class="material-icons left">warning</i>
                                <span>This test has failed steps. Please review and take necessary actions.</span>
                            </div>
                        ` : `
                            <div class="card-panel green lighten-4" style="margin-top: 20px;">
                                <i class="material-icons left">check_circle</i>
                                <span>All test steps passed successfully!</span>
                            </div>
                        `}
                        
                        ${testResults.notes ? `
                            <div style="margin-top: 20px;">
                                <h6>Notes</h6>
                                <p>${testResults.notes}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function restoreStepValues() {
            // Restore personnel values
            for (let i = 1; i <= 3; i++) {
                const techEl = document.getElementById(`technician${i}`);
                const contEl = document.getElementById(`contractor${i}`);
                
                if (techEl && testResults.technicians[i-1]) {
                    techEl.value = testResults.technicians[i-1];
                    M.updateTextFields();
                }
                
                if (contEl && testResults.contractors[i-1]) {
                    contEl.value = testResults.contractors[i-1];
                    M.updateTextFields();
                }
            }
            
            // Restore step values if we're on a step
            if (currentWizardStep > 0 && currentWizardStep <= currentTest.steps.length) {
                const step = currentTest.steps[currentWizardStep - 1];
                const stepData = testResults.steps[step.stepNumber];
                
                if (stepData) {
                    // Restore result
                    if (stepData.result) {
                        const radio = document.querySelector(`input[name="step-${step.stepNumber}-result"][value="${stepData.result}"]`);
                        if (radio) radio.checked = true;
                    }
                    
                    // Restore performer
                    const performerSelect = document.getElementById(`step-${step.stepNumber}-performer`);
                    if (performerSelect && stepData.performer) {
                        performerSelect.value = stepData.performer;
                        M.FormSelect.init(performerSelect);
                    }
                    
                    // Restore notes
                    const notesEl = document.getElementById(`step-${step.stepNumber}-notes`);
                    if (notesEl && stepData.notes) {
                        notesEl.value = stepData.notes;
                        M.textareaAutoResize(notesEl);
                        M.updateTextFields();
                    }
                    
                    // Show timestamp
                    if (stepData.performedAt) {
                        const timestampEl = document.getElementById(`step-${step.stepNumber}-timestamp`);
                        if (timestampEl) {
                            timestampEl.textContent = `Performed at: ${stepData.performedAt}`;
                        }
                    }
                }
            }
            
            // Restore overall notes if on summary
            const overallNotesEl = document.getElementById('overallNotes');
            if (overallNotesEl && testResults.notes) {
                overallNotesEl.value = testResults.notes;
                M.textareaAutoResize(overallNotesEl);
                M.updateTextFields();
            }
        }

        function restoreAllStepValues() {
            // Restore all step data for classic mode
            currentTest.steps.forEach(step => {
                const stepData = testResults.steps[step.stepNumber];
                
                if (stepData) {
                    // Restore result
                    if (stepData.result) {
                        const radio = document.querySelector(`input[name="step-${step.stepNumber}-result"][value="${stepData.result}"]`);
                        if (radio) radio.checked = true;
                    }
                    
                    // Restore performer
                    const performerSelect = document.getElementById(`step-${step.stepNumber}-performer`);
                    if (performerSelect && stepData.performer) {
                        setTimeout(() => {
                            performerSelect.value = stepData.performer;
                            M.FormSelect.init(performerSelect);
                        }, 200);
                    }
                    
                    // Show timestamp
                    if (stepData.performedAt) {
                        const timestampEl = document.getElementById(`step-${step.stepNumber}-timestamp`);
                        if (timestampEl) {
                            timestampEl.textContent = `Performed at: ${stepData.performedAt}`;
                        }
                    }
                }
            });
        }

        function updatePersonnelDropdowns() {
            const allPersonnel = [...testResults.technicians.map(t => `Technician: ${t}`), 
                                 ...testResults.contractors.map(c => `Contractor: ${c}`)];
            
            // Update dropdowns for current step in wizard mode or all steps in classic mode
            const stepsToUpdate = wizardMode && currentWizardStep > 0 && currentWizardStep <= currentTest.steps.length 
                ? [currentTest.steps[currentWizardStep - 1]]
                : currentTest.steps;
            
            stepsToUpdate.forEach(step => {
                const select = document.getElementById(`step-${step.stepNumber}-performer`);
                if (select) {
                    const currentValue = testResults.steps[step.stepNumber]?.performer || '';
                    
                    select.innerHTML = '<option value="">Select who performed this step</option>';
                    
                    allPersonnel.forEach(person => {
                        const option = document.createElement('option');
                        option.value = person;
                        option.textContent = person;
                        if (person === currentValue) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    
                    select.disabled = allPersonnel.length === 0;
                    M.FormSelect.init(select);
                }
            });
        }

        function initializeMaterializeComponents() {
            // Fix for textareaAutoResize error
            const textareas = document.querySelectorAll('.materialize-textarea');
            textareas.forEach(textarea => {
                try {
                    M.textareaAutoResize(textarea);
                } catch (e) {
                    // Fallback if textareaAutoResize fails
                    textarea.style.height = 'auto';
                    textarea.style.overflow = 'hidden';
                }
            });
            M.updateTextFields();
            M.FormSelect.init(document.querySelectorAll('select'));
        }

        function showImage(imageUrl) {
            document.getElementById('previewImage').src = imageUrl;
            currentImageZoom = 1;
            resetZoom();
            const modal = M.Modal.getInstance(document.getElementById('imageModal'));
            modal.open();
        }

        function zoomImage(delta) {
            currentImageZoom = Math.max(0.5, Math.min(3, currentImageZoom + delta));
            const img = document.getElementById('previewImage');
            img.style.transform = `scale(${currentImageZoom})`;
        }

        function resetZoom() {
            currentImageZoom = 1;
            const img = document.getElementById('previewImage');
            img.style.transform = 'scale(1)';
            img.style.transition = 'transform 0.3s ease';
        }

        // Add missing functions
        function updatePersonnel() {
            // Collect technicians
            const technicians = [];
            for (let i = 1; i <= 3; i++) {
                const techEl = document.getElementById(`technician${i}`);
                if (techEl && techEl.value.trim()) {
                    technicians.push(techEl.value.trim());
                }
            }
            
            // Collect contractors
            const contractors = [];
            for (let i = 1; i <= 3; i++) {
                const contEl = document.getElementById(`contractor${i}`);
                if (contEl && contEl.value.trim()) {
                    contractors.push(contEl.value.trim());
                }
            }
            
            // Update test results
            testResults.technicians = technicians;
            testResults.contractors = contractors;
            
            // Update dropdowns if not in wizard mode or past personnel step
            if (!wizardMode || currentWizardStep > 0) {
                updatePersonnelDropdowns();
            }
            
            // Auto-save after updating personnel
            saveTestProgress();
        }
        
        function updateStepResult(stepNumber, result) {
            if (!testResults.steps[stepNumber]) {
                testResults.steps[stepNumber] = {};
            }
            testResults.steps[stepNumber].result = result;
            
            // Update visual indicator in wizard mode
            if (wizardMode) {
                renderTestContent();
            } else {
                // Update the step's visual state
                const stepEl = document.getElementById(`step-${stepNumber}`);
                if (stepEl) {
                    stepEl.classList.remove('completed', 'failed');
                    if (result === 'pass') {
                        stepEl.classList.add('completed');
                    } else if (result === 'fail') {
                        stepEl.classList.add('failed');
                    }
                }
            }
            
            // Auto-save after updating step result
            saveTestProgress();
        }
        
        function updateStepPerformer(stepNumber, performer) {
            if (!testResults.steps[stepNumber]) {
                testResults.steps[stepNumber] = {};
            }
            testResults.steps[stepNumber].performer = performer;
            
            // Add timestamp
            if (performer) {
                const now = new Date();
                testResults.steps[stepNumber].performedAt = now.toLocaleTimeString();
                
                // Update timestamp display
                const timestampEl = document.getElementById(`step-${stepNumber}-timestamp`);
                if (timestampEl) {
                    timestampEl.textContent = `Performed at: ${testResults.steps[stepNumber].performedAt}`;
                }
            }
            
            // Auto-save after updating performer
            saveTestProgress();
        }
        
        function updateStepNotes(stepNumber, notes) {
            if (!testResults.steps[stepNumber]) {
                testResults.steps[stepNumber] = {};
            }
            testResults.steps[stepNumber].notes = notes;
            
            // Auto-save after updating notes
            saveTestProgress();
        }
        
        function nextStep() {
            const totalSteps = currentTest.steps.length + 2;
            
            if (!validateCurrentStep()) {
                M.toast({html: 'Please complete the current step before proceeding.', classes: 'orange'});
                return;
            }
            
            if (currentWizardStep < totalSteps - 1) {
                currentWizardStep++;
                renderTestContent();
                
                // Update button text
                const nextBtn = document.getElementById('nextStepBtn');
                if (currentWizardStep === totalSteps - 1) {
                    nextBtn.innerHTML = 'Review & Submit<i class="material-icons right">check</i>';
                }
            }
            
            // Auto-save after moving to next step
            saveTestProgress();
        }
        
        function previousStep() {
            if (currentWizardStep > 0) {
                currentWizardStep--;
                renderTestContent();
                
                // Update button text
                const nextBtn = document.getElementById('nextStepBtn');
                nextBtn.innerHTML = 'Next<i class="material-icons right">arrow_forward</i>';
            }
            
            // Auto-save after moving to previous step
            saveTestProgress();
        }
        
        function startTest(procedureId) {
            console.log('Starting test:', procedureId);
            
            currentTest = testProcedures.find(p => p.id === procedureId);
            if (!currentTest) {
                console.error('Test procedure not found:', procedureId);
                M.toast({html: 'Error: Test procedure not found'});
                return;
            }
            
            // Check for saved progress
            const progressLoaded = loadTestProgress();
            
            if (!progressLoaded) {
                // Initialize test results with personnel arrays
                testResults = {
                    assetId: currentAsset.id,
                    procedureId: currentTest.id,
                    date: new Date().toLocaleDateString('en-GB'),
                    technicians: [],
                    contractors: [],
                    steps: {},
                    notes: '',
                    timestamp: new Date().toISOString()
                };
                
                // Reset wizard step
                currentWizardStep = 0;
            }
            
            // Update modal content
            document.getElementById('testProcedureName').textContent = currentTest.name;
            
            // Setup wizard mode toggle
            const wizardToggle = document.getElementById('wizardModeToggle');
            wizardToggle.checked = wizardMode;
            wizardToggle.addEventListener('change', function() {
                wizardMode = this.checked;
                renderTestContent();
            });
            
            renderTestContent();
            
            // Close asset modal
            const assetModal = M.Modal.getInstance(document.getElementById('assetModal'));
            assetModal.close();
            
            // Open test modal after a short delay
            setTimeout(() => {
                const testModal = M.Modal.getInstance(document.getElementById('testModal'));
                testModal.open();
            }, 300);
        }

        // Add auto-save functionality
        function saveTestProgress() {
            if (!currentTest || !currentAsset) return;
            
            const progressKey = `testProgress_${currentAsset.id}_${currentTest.id}`;
            const progressData = {
                testResults: testResults,
                currentWizardStep: currentWizardStep,
                wizardMode: wizardMode,
                savedAt: new Date().toISOString(),
                assetName: currentAsset.name,
                procedureName: currentTest.name
            };
            
            localStorage.setItem(progressKey, JSON.stringify(progressData));
            console.log('Test progress saved');
        }
        
        function loadTestProgress() {
            if (!currentTest || !currentAsset) return false;
            
            const progressKey = `testProgress_${currentAsset.id}_${currentTest.id}`;
            const savedProgress = localStorage.getItem(progressKey);
            
            if (!savedProgress) return false;
            
            try {
                const progressData = JSON.parse(savedProgress);
                
                // Check if saved progress is less than 24 hours old
                const savedTime = new Date(progressData.savedAt);
                const hoursSinceSave = (new Date() - savedTime) / (1000 * 60 * 60);
                
                if (hoursSinceSave > 24) {
                    // Progress too old, clear it
                    localStorage.removeItem(progressKey);
                    return false;
                }
                
                // Ask user if they want to resume
                const resume = confirm(`Found saved progress for "${progressData.procedureName}" test on ${progressData.assetName}.\n\nWould you like to resume where you left off?`);
                
                if (resume) {
                    testResults = progressData.testResults;
                    currentWizardStep = progressData.currentWizardStep;
                    wizardMode = progressData.wizardMode;
                    
                    // Update wizard toggle
                    const wizardToggle = document.getElementById('wizardModeToggle');
                    if (wizardToggle) {
                        wizardToggle.checked = wizardMode;
                    }
                    
                    return true;
                } else {
                    // User chose not to resume, clear saved progress
                    localStorage.removeItem(progressKey);
                }
            } catch (error) {
                console.error('Error loading saved progress:', error);
                localStorage.removeItem(progressKey);
            }
            
            return false;
        }
        
        function clearTestProgress() {
            if (!currentTest || !currentAsset) return;
            
            const progressKey = `testProgress_${currentAsset.id}_${currentTest.id}`;
            localStorage.removeItem(progressKey);
        }
        
        // Modify existing functions to include auto-save
        function updatePersonnel() {
            // Collect technicians
            const technicians = [];
            for (let i = 1; i <= 3; i++) {
                const techEl = document.getElementById(`technician${i}`);
                if (techEl && techEl.value.trim()) {
                    technicians.push(techEl.value.trim());
                }
            }
            
            // Collect contractors
            const contractors = [];
            for (let i = 1; i <= 3; i++) {
                const contEl = document.getElementById(`contractor${i}`);
                if (contEl && contEl.value.trim()) {
                    contractors.push(contEl.value.trim());
                }
            }
            
            // Update test results
            testResults.technicians = technicians;
            testResults.contractors = contractors;
            
            // Update dropdowns if not in wizard mode or past personnel step
            if (!wizardMode || currentWizardStep > 0) {
                updatePersonnelDropdowns();
            }
            
            // Auto-save after updating personnel
            saveTestProgress();
        }
        
        function updateStepResult(stepNumber, result) {
            if (!testResults.steps[stepNumber]) {
                testResults.steps[stepNumber] = {};
            }
            testResults.steps[stepNumber].result = result;
            
            // Update visual indicator in wizard mode
            if (wizardMode) {
                renderTestContent();
            } else {
                // Update the step's visual state
                const stepEl = document.getElementById(`step-${stepNumber}`);
                if (stepEl) {
                    stepEl.classList.remove('completed', 'failed');
                    if (result === 'pass') {
                        stepEl.classList.add('completed');
                    } else if (result === 'fail') {
                        stepEl.classList.add('failed');
                    }
                }
            }
            
            // Auto-save after updating step result
            saveTestProgress();
        }
        
        function updateStepPerformer(stepNumber, performer) {
            if (!testResults.steps[stepNumber]) {
                testResults.steps[stepNumber] = {};
            }
            testResults.steps[stepNumber].performer = performer;
            
            // Add timestamp
            if (performer) {
                const now = new Date();
                testResults.steps[stepNumber].performedAt = now.toLocaleTimeString();
                
                // Update timestamp display
                const timestampEl = document.getElementById(`step-${stepNumber}-timestamp`);
                if (timestampEl) {
                    timestampEl.textContent = `Performed at: ${testResults.steps[stepNumber].performedAt}`;
                }
            }
            
            // Auto-save after updating performer
            saveTestProgress();
        }
        
        function updateStepNotes(stepNumber, notes) {
            if (!testResults.steps[stepNumber]) {
                testResults.steps[stepNumber] = {};
            }
            testResults.steps[stepNumber].notes = notes;
            
            // Auto-save after updating notes
            saveTestProgress();
        }
        
        function nextStep() {
            const totalSteps = currentTest.steps.length + 2;
            
            if (!validateCurrentStep()) {
                M.toast({html: 'Please complete the current step before proceeding.', classes: 'orange'});
                return;
            }
            
            if (currentWizardStep < totalSteps - 1) {
                currentWizardStep++;
                renderTestContent();
                
                // Update button text
                const nextBtn = document.getElementById('nextStepBtn');
                if (currentWizardStep === totalSteps - 1) {
                    nextBtn.innerHTML = 'Review & Submit<i class="material-icons right">check</i>';
                }
            }
            
            // Auto-save after moving to next step
            saveTestProgress();
        }
        
        function previousStep() {
            if (currentWizardStep > 0) {
                currentWizardStep--;
                renderTestContent();
                
                // Update button text
                const nextBtn = document.getElementById('nextStepBtn');
                nextBtn.innerHTML = 'Next<i class="material-icons right">arrow_forward</i>';
            }
            
            // Auto-save after moving to previous step
            saveTestProgress();
        }
        
        // Add cleanup for when test modal is closed without submission
        document.addEventListener('DOMContentLoaded', function() {
            // ...existing code...
            
            // Add modal close event listener
            const testModal = document.getElementById('testModal');
            const testModalInstance = M.Modal.init(testModal, {
                onCloseEnd: function() {
                    // Save progress when modal is closed
                    if (currentTest && currentAsset && testResults.steps && Object.keys(testResults.steps).length > 0) {
                        saveTestProgress();
                        M.toast({html: 'Test progress saved. You can resume later.', classes: 'blue'});
                    }
                }
            });
        });
    </script>
</body>
</html>
